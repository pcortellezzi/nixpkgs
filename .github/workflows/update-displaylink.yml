name: Update displaylink package

on:
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
  schedule:
    - cron: '0 9 * * *' # Runs every day at 9:00 AM

jobs:
  update-displaylink:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Update displaylink from nixpkgs
        run: |
          set -euo pipefail
          
          echo "Fetching latest package information from nixpkgs..."
          NIXPKGS_URL="https://raw.githubusercontent.com/NixOS/nixpkgs/nixos-unstable/pkgs/os-specific/linux/displaylink/default.nix"
          CONTENT=$(curl -s "$NIXPKGS_URL")
          
          NEW_VERSION=$(echo "$CONTENT" | grep 'version =' | head -n 1 | cut -d'"' -f2)
          NEW_HASH=$(echo "$CONTENT" | grep 'hash =' | head -n 1 | cut -d'"' -f2)
          NEW_URL=$(echo "$CONTENT" | grep -o 'https://www.synaptics.com/sites/default/files/exe_files/[^ ]*\.zip' | head -n 1)

          if [ -z "$NEW_VERSION" ] || [ -z "$NEW_HASH" ] || [ -z "$NEW_URL" ]; then
            echo "Error: Could not extract information from nixpkgs."
            exit 1
          fi

          echo "Latest version in nixpkgs: $NEW_VERSION"
          
          # Mise à jour du fichier local
          # On utilise | comme séparateur pour sed à cause des / dans l'URL et le hash
          sed -i "s|url = ".*";|url = \"$NEW_URL\";|" overlays/displaylink.nix
          sed -i "s|hash = ".*";|hash = \"$NEW_HASH\";|" overlays/displaylink.nix

          echo "Successfully updated displaylink local overlay to version $NEW_VERSION."

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          if ! git diff --quiet overlays/displaylink.nix; then
            git add overlays/displaylink.nix
            git commit -m "displaylink: sync with nixpkgs"
            git push
          else
            echo "No changes detected for displaylink."
          fi