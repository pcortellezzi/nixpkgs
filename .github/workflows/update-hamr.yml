name: Update hamr package

on:
  workflow_dispatch: # Allows you to run this workflow manually from the Actions tab
  schedule:
    - cron: '0 11 * * *' # Runs every day at 11:00 AM

jobs:
  update-hamr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Update hamr package
        run: |
          set -euo pipefail

          # Get current version from file
          CURRENT_VERSION=$(grep 'version = "' pkgs/hamr/default.nix | head -n 1 | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"

          # Fetch latest release info from GitHub
          echo "Fetching latest release information..."
          LATEST_RELEASE_JSON=$(curl -s https://api.github.com/repos/Stewart86/hamr/releases/latest)
          LATEST_TAG=$(echo "$LATEST_RELEASE_JSON" | jq -r .tag_name)
          
          if [ "$LATEST_TAG" == "null" ]; then
             echo "Failed to fetch latest tag."
             exit 1
          fi

          # Remove 'v' prefix if present for version comparison/usage
          NEW_VERSION=${LATEST_TAG#v}
          echo "Latest version: $NEW_VERSION"

          if [ "$CURRENT_VERSION" == "$NEW_VERSION" ]; then
            echo "hamr is already up to date."
            exit 0
          fi

          echo "New version found. Updating from $CURRENT_VERSION to $NEW_VERSION..."

          # Calculate new hash
          # fetchFromGitHub downloads the archive.
          URL="https://github.com/Stewart86/hamr/archive/refs/tags/${LATEST_TAG}.tar.gz"
          echo "Prefetching URL: $URL"
          
          # Prefetch and get SHA256 (default base32)
          RAW_HASH=$(nix-prefetch-url --unpack "$URL")
          
          # Convert to SRI
          SRI_HASH=$(nix hash to-sri --type sha256 "$RAW_HASH")
          echo "New Hash (SRI): $SRI_HASH"

          # Update the file
          sed -i "s|version = ".*"|version = \"$NEW_VERSION\"|" pkgs/hamr/default.nix
          # Use a regex that matches the specific hash line structure to avoid accidents, 
          # assuming it's `hash = "sha256-..."`
          sed -i "s|hash = ".*"|hash = \"$SRI_HASH\"|" pkgs/hamr/default.nix

          echo "File updated. Verifying build..."
      
      - name: Build hamr
        run: |
          # Verify that it builds
          nix build .#hamr
          echo "Build successful."

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Check if there are changes (there should be if version changed)
          if ! git diff --quiet pkgs/hamr/default.nix; then
            NEW_VERSION=$(grep 'version = "' pkgs/hamr/default.nix | head -n 1 | cut -d'"' -f2)
            git add pkgs/hamr/default.nix
            git commit -m "hamr: Auto-update to $NEW_VERSION"
            git push
          else
            echo "No changes to commit."
          fi
